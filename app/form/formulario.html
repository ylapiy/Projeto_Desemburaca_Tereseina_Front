<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio de Den√∫ncia</title>
    <link rel="stylesheet" href="formulario.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="../../assets/logoPrefeitura.svg" alt="Logo da Prefeitura" class="imagemLogodaPrefeitura">
            <span class="NomedaAplica√ß√£o">| Den√∫ncia de Buracos - Formulario</span>
        </div>
        <div class="navbar-links">
            <a href="../home/index.html" style="text-decoration: none"><span class="textoDaBarra">Inicio</span></a>
            <a href="../sobre/sobre.html" style="text-decoration: none"><span class="textoDaBarra">Sobre o projeto</span></a>
            <a href="../ajuda/ajuda.html" style="text-decoration: none"><span class="textoDaBarra">Ajuda</span></a>
        </div>
    </nav>

    <div class="container">

        <div class="fundoescuro">
        <div class ="popupenvio">
        <H2>Denuncia enviada com sucesso!</H2>
        <button class="fechar" id="fecharenvio">X</button>
        </div>
        <div class="popupfaltaImage">
            <h1>Denuncia sem foto!</h1>
            <H2>√â necess√°rio uma foto colocada junto do envio, por favor use uma das duas op√ß√µes dispon√≠veis.</H2>
            <button class="fechar" id="fecharimagem">X</button>
        </div>
        </div>

        <form class="form-container" id="form-denuncia">
            <h2>Formul√°rio de Den√∫ncia</h2>
            
            <div class="form-group">
                <label for="location">Localiza√ß√£o:</label>
                <input type="text" id="location" name="location" placeholder="Digite o endere√ßo do buraco" required>
            </div>

            <div class="form-group">
                <label for="size">Tamanho do buraco:</label>
                <select id="size" name="size" required>
                    <option value="">Selecione o tamanho</option>
                    <option value="small">Pequeno (at√© 30cm)</option>
                    <option value="medium">M√©dio (30cm - 1m)</option>
                    <option value="large">Grande (mais de 1m)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="description">Descri√ß√£o adicional:</label>
                <textarea id="description" name="description" rows="4" placeholder="Descreva detalhes adicionais sobre o a localiza√ß√£o do buraco" required></textarea>
            </div>

            <div class="form-group">
                <label for="photo">Foto do buraco :</label>
                <input type="file" id="photo" name="photo" accept="image/*, text/plain" style="display:none;">
                <button class="botaodecamera" type="button" id="iconephoto"  onclick="document.getElementById('photo').click()"> Colocar Foto da Galeria</button>
                <label for="camera">Tirar foto agora :</label>
                <input type="file" id="camera" name="camera" accept="image/*" capture="environment" style="display:none;">
                <button class="botaodecamera" type="button" id="iconecamera" onclick="document.getElementById('camera').click()">üì∑ Usar C√¢mera</button>
            </div>

           <div class="conteinerDeBotoes">
                <button class="submit-btn" id="submit">Enviar Denuncia</button>
                <a href="../ajuda/ajuda.html"><button type="button" class="botaolinkaajuda" id="linkajuda">i</button></a>
           </div>
        </form>

    </div>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
<script src="TeresinaPontos.js"></script> 
<script type="module">

import {PreparandoEnvioOFF,tentarEnviar,LeituraDefoto,TransformaCordenada,resetTodos,verificaTeresina,RevesaoGeografica, DriveUploader,PostBancoDeDados,loopDeAnim,LimpezadeForm} from './FuncoesPrincipais.js'

window.esperandoConc =  localStorage.getItem('SerReiniciar')
window.lat2 = null;
window.lon2 = null;
window.Data = null;
window.Foto = null;
window.Rua = null;
window.Bairro = null;
window.timeoutAnimacao = null;

console.log(localStorage.getItem('SerReiniciar'))
console.log(window.esperandoConc)

/*  script para verificar se a imagem tem tudo certinho, data, gps e depois se internet ta on ne,
    agora se tu me perguntar, pq um site op√ß√£o de selavar offline, eu te respondo, boa pergunta! N√£o mas, a
    agora √© serio, √© pq mesmo sentdo um site agora isso foi pensado pra posteriomenter virar aplicativo
    ent√£o na realidade faz sentido (eu acho) */

document.getElementById('form-denuncia').addEventListener('submit', (Entrada) => {  
            Entrada.preventDefault()
            const arquivo = document.getElementById('photo');
            const camera = document.getElementById('camera');
            const butao = document.querySelector('.submit-btn');
            const formulario = document.getElementById('form-denuncia')
            var categoria = null

            if(formulario.size.value == "small"){categoria = 1}else{if(formulario.size.value == "medium"){categoria = 2}else{if(formulario.size.value== "large"){categoria = 3}}}

            console.log("Arquivo selecionado:", arquivo.files.length);
            console.log("Camera selecionada:", camera.files.length);

            if(arquivo.files.length || camera.files.length){
                if(butao.textContent == "Enviar Denuncia"){
                    console.log('enviando denuncia')
                    butao.textcontent = "Enviando Denuncia, aguarde"
                    console.log('Situa√ß√£o da conc:', window.esperandoConc)
                    butao.disabled = true; 

                    RevesaoGeografica(window.lon2,window.lat2).then(() => {
                    butao.disabled = true; 
                    console.log(window.Data,categoria,formulario.description.value,window.Nome,window.lon2,window.lat2,window.Bairro,window.Rua)
                    PostBancoDeDados(window.Data,categoria,formulario.description.value,window.Nome,window.lon2,window.lat2,window.Bairro,window.Rua) 
                    DriveUploader(window.Foto).then(() => {butao.disabled = false;butao.textcontent = "Enviar Den√∫ncia";
                    document.querySelector('.popupenvio').style.visibility = 'visible';
                    document.querySelector('.popupenvio').style.display = 'flex';
                    document.querySelector('.fundoescuro').style.visibility = 'visible';
                    document.querySelector('.fundoescuro').style.display = 'flex';
                    LimpezadeForm();
                    ;}) 
                    
                    var contador = 0
                    loopDeAnim(contador,"Enviando Denuncia, aguarde") 

                    })

                }else{
                    window.esperandoConc = true;
                    butao.disabled = true;
                    console.log('salvando denuncia')
                    console.log('Esperando conc:', window.esperandoConc)

                    localStorage.setItem('SerReiniciar',window.esperandoConc );
                    console.log(localStorage.getItem('SerReiniciar'))

                    PreparandoEnvioOFF()

                    var contador = 0
                    loopDeAnim(contador,"Denuncia Salva, esperando conex√£o com a internet para finalizar a denuncia")
                }

            }else{
                document.querySelector('.popupfaltaImage').style.visibility = 'visible';
                document.querySelector('.popupfaltaImage').style.display = 'flex';
                document.querySelector('.fundoescuro').style.visibility = 'visible';
                document.querySelector('.fundoescuro').style.display = 'flex';
                return;
            }
        });
        
document.getElementById('photo').addEventListener('change', (Entrada) => {

             const camera = document.getElementById('iconecamera')
             camera.innerText =  "üì∑ Usar C√¢mera"
             document.getElementById('camera').value = ""; 

             const arquivo = document.getElementById('iconephoto')
             arquivo.innerText = "Colocar Foto da Galeria - ‚úîÔ∏è"
             LeituraDefoto(Entrada)  
        });
        
document.getElementById('camera').addEventListener('change', (Entrada) => {
            const camera = document.getElementById('iconecamera')
            camera.innerText =  "üì∑ Usar C√¢mera - ‚úîÔ∏è "

            const arquivo = document.getElementById('iconephoto')
            document.getElementById('photo').value = ""; 
            arquivo.innerText = "Colocar Foto da Galeria"
            LeituraDefoto(Entrada)
});

document.getElementById('fecharenvio').addEventListener('click',() =>{
    document.querySelector('.popupenvio').style.visibility = 'hidden';
    document.querySelector('.popupenvio').style.display = 'none';
    document.querySelector('.fundoescuro').style.visibility = 'hidden';
    document.querySelector('.fundoescuro').style.display = 'hidden';
})

document.getElementById('fecharimagem').addEventListener('click',() =>{
    document.querySelector('.popupfaltaImage').style.visibility = 'hidden';
    document.querySelector('.popupfaltaImage').style.display = 'none';
    document.querySelector('.fundoescuro').style.visibility = 'hidden';
    document.querySelector('.fundoescuro').style.display = 'hidden';
})

window.addEventListener('online', () => {
            const arquivo = document.getElementById('photo');
            const camera = document.getElementById('camera');
            const formulario = document.getElementById('form-denuncia')
            const butao = document.querySelector('.submit-btn');
        
            if (window.timeoutAnimacao) {
             clearTimeout(window.timeoutAnimacao); 
             window.timeoutAnimacao = null;         
            }

            const dados = Object.fromEntries(new FormData(formulario).entries());
            var categoria = null
            if(dados.size == "small"){categoria = 1}else{if(dados.size == "medium"){categoria = 2}else{if(dados.size == "large"){categoria = 3}}}

            if (window.esperandoConc === true) {
            
            window.esperandoConc = false
            localStorage.setItem('SerReiniciar',window.esperandoConc);

            try {
            butao.disabled = true;
                var contador = 0
                loopDeAnim(contador,"Enviando Denuncia, aguarde")  
                tentarEnviar();

            } catch (erro) {

            console.error(erro);
            }

            butao.textContent = "Enviar Denuncia";
            }
        });
window.addEventListener('offline', () => {
            const butao = document.querySelector('.submit-btn');
            butao.textContent = "Salvar Denuncia"; 
        });
window.addEventListener('onload', () =>{
    const butao = document.querySelector('.submit-btn');
    if(localStorage.getItem(SerReiniciar) === false){tentarEnviar();}else{butao.disabled = true;var contador = 0;oopDeAnim(contador,"Denuncia Salva, esperando conec√ß√£o com a internter para finalizar a denuncia")
    }

})
document.addEventListener('DOMContentLoaded', () => {
           const butao = document.querySelector('.submit-btn');
           if(navigator.onLine){
            Window.esperandoConc = false;
            butao.textContent = "Enviar Denuncia"; 
           }else{
            butao.textContent = "Salvar Denuncia"; 
           }
        });

</script>
</body>
<footer class="footer">
    <div class="footer-content">
        <div class="footer-left">
            <p>&copy; 2025 Prefeitura Municipal de Tereseina - Desemburaca Teresina. Todos os direitos reservados.</p>
        </div>
    </div>
</footer>
</html>