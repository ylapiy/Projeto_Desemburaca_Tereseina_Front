<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio de Den√∫ncia</title>
    <link rel="stylesheet" href="formulario.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="../../assets/logoPrefeitura.svg" alt="Logo da Prefeitura" class="imagemLogodaPrefeitura">
            <span class="NomedaAplica√ß√£o">| Den√∫ncia de Buracos</span>
        </div>
        <div class="navbar-links">
            <a href="../home/index.html"><span class="textoDaBarra">Inicio</span></a>
            <a href="../serv/serv.html"><span class="textoDaBarra">Servi√ßos</span></a>
            <a href="../sobre/sobre.html"><span class="textoDaBarra">Saiba Mais</span></a>
        </div>
    </nav>

    <div class="container">
        <form class="form-container" id="form-denuncia">
            <h2>Formul√°rio de Den√∫ncia</h2>
            
            <div class="form-group">
                <label for="location">Localiza√ß√£o:</label>
                <input type="text" id="location" name="location" placeholder="Digite o endere√ßo do buraco" required>
            </div>

            <div class="form-group">
                <label for="size">Tamanho do buraco:</label>
                <select id="size" name="size" required>
                    <option value="">Selecione o tamanho</option>
                    <option value="small">Pequeno (at√© 30cm)</option>
                    <option value="medium">M√©dio (30cm - 1m)</option>
                    <option value="large">Grande (mais de 1m)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="description">Descri√ß√£o adicional:</label>
                <textarea id="description" name="description" rows="4" placeholder="Descreva detalhes adicionais sobre o a localiza√ß√£o do buraco"></textarea>
            </div>

            <div class="form-group">
                <label for="photo">Foto do buraco:</label>
                <input type="file" id="photo" name="photo" accept="image/*">
                <label for="camera">Tirar Foto Agora:</label>
                <input type="file" id="camera" name="camera" accept="image/*" capture="environment" style="display:none;">
                <button type="button" onclick="document.getElementById('camera').click()">üì∑ Usar C√¢mera</button>
            </div>

            <button class="submit-btn" id="submit">Enviar Denuncia</button>
            <div class="popupCarregamentoInternet"></div>
            <h2> Denuncia Salva </h2>
            <p> para finalizar o envio conecte a internet</p>
            <button type="button"> cancelar envio </button>
        </form>

    </div>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
<script src="TeresinaPontos.js"></script> 
<script type="module">

    import {PreparandoEnvioOFF,tentarEnviar,LeituraDefoto,TransformaCordenada,resetTodos,verificaTeresina,RevesaoGeografica, DriveUploader,PostBancoDeDados, GetBancoDeDados} from './FuncoesPrincipais.js'

    window.lat2 = null;
    window.lon2 = null;
    window.Data = null;
    window.Foto = null;
    window.esperandoConc = false;

    /* 
    script para verificar se a imagem tem tudo certinho, data, gps e depois se internet ta on ne,
    agora se tu me perguntar, pq um site op√ß√£o de selavar offline, eu te respondo, boa pergunta! N√£o mas, a
    agora √© serio, √© pq mesmo sentdo um site agora isso foi pensado pra posteriomenter virar aplicativo
    ent√£o na realidade faz sentido (eu acho) 
    */

    document.getElementById('form-denuncia').addEventListener('submit', (Entrada) => {
            Entrada.preventDefault()
            const arquivo = document.getElementById('photo');
            const camera = document.getElementById('camera');
            const butao = document.querySelector('.submit-btn');
            const formulario = document.getElementById('form-denuncia')

            const dados = Object.fromEntries(new FormData(formulario).entries());
            var categoria = null

            if(dados.size == "small"){categoria = 1}else{if(dados.size == "medium"){categoria = 2}else{if(dados.size == "large"){categoria = 3}}}

            console.log("Arquivo selecionado:", arquivo.files.length);
            console.log("Camera selecionada:", camera.files.length);

            if(arquivo.files.length || camera.files.length){
                if(butao.textContent == "Enviar Denuncia"){
                    console.log('enviando denuncia')
                    console.log('Situa√ß√£o da conc:', window.esperandoConc)
                    RevesaoGeografica(window.lon2,window.lat2).then(() => {
                    butao.disabled = true;
                    butao.textContent = "Enviando dados, por favor aguarde..."
                    console.log(window.Data,categoria,dados.description,window.Nome,window.lon2,window.lat2,window.Bairro,window.Rua)
                    PostBancoDeDados(window.Data,categoria,dados.description,window.Nome,window.lon2,window.lat2,window.Bairro,window.Rua) 
                    DriveUploader(window.Foto).then(() => {butao.disabled = false; butao.textContent = "Enviar Denuncia"})
                    })
                }else{
                    window.esperandoConc = true;
                    console.log('salvando denuncia')
                    console.log('Situa√ß√£o da conc:', window.esperandoConc)
                    /*PreparandoEnvioOFF();*/
                }

            }else{
                alert('√â necess√°rio uma foto colocada junto do envio, por favor use uma das op√ß√µes dispon√≠veis.');
                return;
            }
        });
        
    document.getElementById('photo').addEventListener('change',  (Entrada) => {
            document.getElementById('camera').value = ""; 
             LeituraDefoto(Entrada)  
        });
        
    document.getElementById('camera').addEventListener('change', (Entrada) => {
            document.getElementById('photo').value = ""; 
            LeituraDefoto(Entrada)
        });

    window.addEventListener('online', () => {
            const butao = document.querySelector('.submit-btn');
            butao.textContent = "Enviar Denuncia"; 
           /* if(window.esperandoConc == true){
            tentarEnviar();
            } */
            window.esperandoConc = false;
        });
    window.addEventListener('offline', () => {
            const butao = document.querySelector('.submit-btn');
            butao.textContent = "Salvar Denuncia"; 
        });
    document.addEventListener('DOMContentLoaded', () => {
           const butao = document.querySelector('.submit-btn');
           if(navigator.onLine){
            Window.esperandoConc = false;
            butao.textContent = "Enviar Denuncia"; 
           }else{
            butao.textContent = "Salvar Denuncia"; 
           }
        });

</script>
</body>
</html>